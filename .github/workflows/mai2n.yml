name: Ollama CI Test (Tunnel)

on:
  workflow_dispatch:

jobs:
  ollama-test:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: Install Ollama
        run: curl -fsSL https://ollama.com/install.sh | sudo sh

      - name: Start Ollama Server
        run: |
          ollama serve &
          sleep 5
          curl -s http://127.0.0.1:11434

      - name: Pull model
        run: ollama pull llama2

      - name: Quick sanity test
        run: ollama run llama2 "Say 'ollama up' in 5 words"

      # ---- Tunnel 11434 to the internet (prints URL) ----
      - name: Install cloudflared
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 \
            -o cloudflared
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin/cloudflared

      - name: Expose Ollama via Cloudflare quick tunnel
        run: |
          cloudflared tunnel --url http://127.0.0.1:11434 --loglevel info --logfile cf.log &
          sleep 5
          TUNNEL_URL=$(grep -oE 'https://[a-z0-9-]+\.trycloudflare\.com' cf.log | head -n 1)
          echo ""
          echo "============================="
          echo "OLLAMA PUBLIC URL:"
          echo "$TUNNEL_URL"
          echo "============================="
          echo ""

      # Keep the runner alive so Mindcraft can use it
      - name: Keep alive (30 min)
        run: sleep 1800
